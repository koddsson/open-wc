<!doctype html>
<html>
  <head>
    <script type="module">
      import { ProviderMixin, ConsumerMixin } from '../../index.ts';
      import {html, css, LitElement} from 'lit';

      window.customElements.define('server-state', class ServerState extends ProviderMixin(LitElement) {
        contexts = {
          'hit-count': () => {
            return 9001;
          }
        }

        render() {
          return html`<slot></slot>`;
        }
      });

      window.customElements.define('hit-count', class HitCount extends ConsumerMixin(LitElement) {
        static get properties() { 
          return {
            hitCount: {type: String}
          }
        }

        contexts = {
          'hit-count': (count) => {
            this.hitCount = `${count} hits!`;
          }
        };

        constructor() {
          super();
          this.hitCount = 'Loading...';
        }

        render() {
          return html`${this.hitCount}`;
        }
      });
    </script>
  </head>
  <body>

    <experience-renderer>
      "I know nothing about [some-data]"

      <feature-a>
        "I know about [some-data]" -> "I need to provide this somehow to any one that wants to know about it"
      </feature-a>

      <feature-b>
        "I want to know [some-data]"
      </feature-b>

    </experience-renderer>


    <server-state>
      <hit-count></hit-count>
    </server-state>

    <script type="module">
      import { runTests } from "@web/test-runner-mocha";
      import { expect } from "chai";
      import { waitUntil } from '@open-wc/testing';

      runTests(() => {
        it("subscribes to changes", async () => {
          const provider = document.querySelector('server-state');
          const el = document.querySelector('hit-count');
          await waitUntil(() => el.shadowRoot.textContent !== 'Loading...');
          expect(el.shadowRoot.textContent).to.equal('9001 hits!');

          provider.updateContext('hit-count', 9002);
          await waitUntil(() => el.shadowRoot.textContent !== '9001 hits!');
          expect(el.shadowRoot.textContent).to.equal('9002 hits!');
        });
      });
    </script>
  </body>
</html>
